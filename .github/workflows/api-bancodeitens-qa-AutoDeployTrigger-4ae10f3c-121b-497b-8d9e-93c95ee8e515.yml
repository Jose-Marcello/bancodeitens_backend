name: Trigger auto deployment for api-bancodeitens-qa

on:
  push:
    branches:
      [ main ]
    paths:
      - '**'
      # Você pode adicionar caminhos específicos aqui, se necessário

  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v2

      # 1. LOGIN NO AZURE COM SERVICE PRINCIPAL (SPN JSON)
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_QA }}
          # Não precisa da subscription ID aqui se o JSON já a tiver.

      # 2. LOGIN NO ACR (Obrigatório para o push)
      - name: ACR Login
        uses: azure/docker-login@v1
        with:
          login-server: acabolaitems.azurecr.io
          username: ${{ secrets.APIBANCODEITENSQA_REGISTRY_USERNAME }}
          password: ${{ secrets.APIBANCODEITENSQA_REGISTRY_PASSWORD }}

      # 3. BUILD MANUAL E PUSH DA IMAGEM CORRETA
      - name: Build and Push Docker Image
        run: |
          # Define o nome da imagem, usando o novo padrão do PoC
          IMAGE_NAME="acabolaitems.azurecr.io/api-bancodeitens-qa:${{ github.sha }}"
          
          # COMANDO BUILD DOCKER (Seu Dockerfile deve estar na raiz do repo)
          docker build . --file Dockerfile --tag $IMAGE_NAME
          
          docker push $IMAGE_NAME

      # 4. DEPLOY MANUAL NO CONTAINER APPS VIA AZ CLI
      - name: Deploy to Azure Container Apps (QA)
        uses: azure/cli@v1
        with:
          # Opcional: Força o contexto de subscrição, se necessário.
          # az account set --subscription "SUA_SUBSCRIPTION_ID_AQUI"
          
          inlineScript: |
            IMAGE_NAME="acabolaitems.azurecr.io/api-bancodeitens-qa:${{ github.sha }}"

            # Atualiza o Container App (ACA) com a nova imagem
            az containerapp update \
              --name api-bancodeitens-qa \
              --resource-group rg-bolao-aca-prod \
              --image $IMAGE_NAME


